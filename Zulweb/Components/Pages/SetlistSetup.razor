@page "/setup"
@using Zulweb.Models
@using Zulweb.Infrastructure
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations
@inject SetlistController Setlist;
@rendermode InteractiveServer

<PageTitle>Setup</PageTitle>
<SfGrid DataSource="@_items" AllowRowDragAndDrop="true">
    <GridEvents TValue="LoadedSetlistItem" RowDropped="Callback"/>
    <GridColumns>
        <GridColumn Field=@nameof(LoadedSetlistItem.RegionName) HeaderText="Name" TextAlign="TextAlign.Left"
                    Width="400" IsPrimaryKey="true"/>
        <GridColumn Field=@nameof(LoadedSetlistItem.Disabled) HeaderText="Disabled" Width="80"/>
        <GridColumn Field=@nameof(LoadedSetlistItem.Sequence) HeaderText="Sequence" Width="150"/>
        <GridColumn Field=@nameof(LoadedSetlistItem.ReaperRegionName) HeaderText="REAPER Region"
                    TextAlign="TextAlign.Right"/>
    </GridColumns>
</SfGrid>

<SfToolbar>
    <ToolbarItems>
    </ToolbarItems>
</SfToolbar>

@code
{
    private List<LoadedSetlistItem>? _items;


    protected override async Task OnParametersSetAsync()
    {
        await LoadItems();
    }

    private async Task LoadItems()
    {
        _items = await Setlist.BuildAll().ToListAsync();
    }

    /*
    private static string FormatReaperRegion(LoadedSetlistItem? item)
    {
        if (item?.Region == null) return "[not found]";
        return $"{item.Region.Id} {item.Region.Name}";
    }
    */

    private Task SaveHandler()
    {
        Setlist.Save();
        return Task.CompletedTask;
    }

    private async Task ImportHandler()
    {
        await Setlist.ImportFromReaper();
        await LoadItems();
    }

    private async Task Callback(RowDroppedEventArgs<LoadedSetlistItem> arg)
    {
        RassignSequence();
        Setlist.Save();
        await Task.CompletedTask;
    }

    private void RassignSequence()
    {
        var start = 0;
        foreach (var item in _items ?? [])
        {
            item.Sequence = ++start;
        }
        StateHasChanged();
    }
}